var languages = ["A# .NET", "A# (Axiom)", "A-0 System", "A+", "A++", "ABAP", "ABC", "ABC ALGOL", "ABLE", "ABSET", "ABSYS", "ACC", "Accent", "Ace DASL", "ACL2", "ACT-III", "Action!", "ActionScript", "Ada", "Adenine", "Agda", "Agilent VEE", "Agora", "AIMMS", "Alef", "ALF", "ALGOL 58", "ALGOL 60", "ALGOL 68", "ALGOL W", "Alice", "Alma-0", "AmbientTalk", "Amiga E", "AMOS", "AMPL", "APL", "App Inventor for Android's visual block language", "AppleScript", "Arc", "ARexx", "Argus", "AspectJ", "Assembly language", "ATS", "Ateji PX", "AutoHotkey", "Autocoder", "AutoIt", "AutoLISP / Visual LISP", "Averest", "AWK", "Axum", "B", "Babbage", "Bash", "BASIC", "bc", "BCPL", "BeanShell", "Batch (Windows/Dos)", "Bertrand", "BETA", "Bigwig", "Bistro", "BitC", "BLISS", "Blue", "Bon", "Boo", "Boomerang", "Bourne shell", "bash", "ksh", "BREW", "BPEL", "C", "C--", "C++", "C#", "C/AL", "Caché ObjectScript", "C Shell", "Caml", "Candle", "Cayenne", "CDuce", "Cecil", "Cel", "Cesil", "Ceylon", "CFEngine", "CFML", "Cg", "Ch", "Chapel", "CHAIN", "Charity", "Charm", "Chef", "CHILL", "CHIP-8", "chomski", "ChucK", "CICS", "Cilk", "CL", "Claire", "Clarion", "Clean", "Clipper", "CLIST", "Clojure", "CLU", "CMS-2", "COBOL", "Cobra", "CODE", "CoffeeScript", "Cola", "ColdC", "ColdFusion", "COMAL", "Combined Programming Language", "COMIT", "Common Intermediate Language", "Common Lisp", "COMPASS", "Component Pascal", "Constraint Handling Rules", "Converge", "Cool", "Coq", "Coral 66", "Corn", "CorVision", "COWSEL", "CPL", "csh", "CSP", "Csound", "CUDA", "Curl", "Curry", "Cyclone", "Cython", "D", "DASL", "DASL", "Dart", "DataFlex", "Datalog", "DATATRIEVE", "dBase", "dc", "DCL", "Deesel", "Delphi", "DinkC", "DIBOL", "Dog", "Draco", "DRAKON", "Dylan", "DYNAMO", "E", "E#", "Ease", "Easy PL/I", "Easy Programming Language", "EASYTRIEVE PLUS", "ECMAScript", "Edinburgh IMP", "EGL", "Eiffel", "ELAN", "Elixir", "Elm", "Emacs Lisp", "Emerald", "Epigram", "EPL", "Erlang", "es", "Escapade", "Escher", "ESPOL", "Esterel", "Etoys", "Euclid", "Euler", "Euphoria", "EusLisp Robot Programming Language", "CMS EXEC", "EXEC 2", "Executable UML", "F", "F#", "Factor", "Falcon", "Fancy", "Fantom", "FAUST", "Felix", "Ferite", "FFP", "Fjölnir", "FL", "Flavors", "Flex", "FLOW-MATIC", "FOCAL", "FOCUS", "FOIL", "FORMAC", "@Formula", "Forth", "Fortran", "Fortress", "FoxBase", "FoxPro", "FP", "FPr", "Franz Lisp", "Frege", "F-Script", "FSProg", "G", "Google Apps Script", "Game Maker Language", "GameMonkey Script", "GAMS", "GAP", "G-code", "Genie", "GDL", "Gibiane", "GJ", "GEORGE", "GLSL", "GNU E", "GM", "Go", "Go!", "GOAL", "Gödel", "Godiva", "GOM (Good Old Mad)", "Goo", "Gosu", "GOTRAN", "GPSS", "GraphTalk", "GRASS", "Groovy", "Hack (programming language)", "HAL/S", "Hamilton C shell", "Harbour", "Hartmann pipelines", "Haskell", "Haxe", "High Level Assembly", "HLSL", "Hop", "Hope", "Hugo", "Hume", "HyperTalk", "IBM Basic assembly language", "IBM HAScript", "IBM Informix-4GL", "IBM RPG", "ICI", "Icon", "Id", "IDL", "Idris", "IMP", "Inform", "Io", "Ioke", "IPL", "IPTSCRAE", "ISLISP", "ISPF", "ISWIM", "J", "J#", "J++", "JADE", "Jako", "JAL", "Janus", "JASS", "Java", "JavaScript", "JCL", "JEAN", "Join Java", "JOSS", "Joule", "JOVIAL", "Joy", "JScript", "JScript .NET", "JavaFX Script", "Julia", "Jython", "K", "Kaleidoscope", "Karel", "Karel++", "KEE", "Kixtart", "KIF", "Kojo", "Kotlin", "KRC", "KRL", "KUKA", "KRYPTON", "ksh", "L", "L# .NET", "LabVIEW", "Ladder", "Lagoona", "LANSA", "Lasso", "LaTeX", "Lava", "LC-3", "Leda", "Legoscript", "LIL", "LilyPond", "Limbo", "Limnor", "LINC", "Lingo", "Linoleum", "LIS", "LISA", "Lisaac", "Lisp", "Lite-C", "Lithe", "Little b", "Logo", "Logtalk", "LPC", "LSE", "LSL", "LiveCode", "LiveScript", "Lua", "Lucid", "Lustre", "LYaPAS", "Lynx", "M2001", "M4", "Machine code", "MAD", "MAD/I", "Magik", "Magma", "make", "Maple", "MAPPER", "MARK-IV", "Mary", "MASM Microsoft Assembly x86", "Mathematica", "MATLAB", "Maxima", "Macsyma", "Max", "MaxScript", "Maya (MEL)", "MDL", "Mercury", "Mesa", "Metacard", "Metafont", "MetaL", "Microcode", "MicroScript", "MIIS", "MillScript", "MIMIC", "Mirah", "Miranda", "MIVA Script", "ML", "Moby", "Model 204", "Modelica", "Modula", "Modula-2", "Modula-3", "Mohol", "MOO", "Mortran", "Mouse", "MPD", "CIL", "MSL", "MUMPS", "NASM", "NATURAL", "Napier88", "Neko", "Nemerle", "nesC", "NESL", "Net.Data", "NetLogo", "NetRexx", "NewLISP", "NEWP", "Newspeak", "NewtonScript", "NGL", "Nial", "Nice", "Nickle", "Nim", "NPL", "Not eXactly C", "Not Quite C", "NSIS", "Nu", "NWScript", "NXT-G", "o:XML", "Oak", "Oberon", "Obix", "OBJ2", "Object Lisp", "ObjectLOGO", "Object REXX", "Object Pascal", "Objective-C", "Objective-J", "Obliq", "Obol", "OCaml", "occam", "occam-π", "Octave", "OmniMark", "Onyx", "Opa", "Opal", "OpenCL", "OpenEdge ABL", "OPL", "OPS5", "OptimJ", "Orc", "ORCA/Modula-2", "Oriel", "Orwell", "Oxygene", "Oz", "P#", "ParaSail (programming language)", "PARI/GP", "Pascal", "Pawn", "PCASTL", "PCF", "PEARL", "PeopleCode", "Perl", "PDL", "PHP", "Phrogram", "Pico", "Picolisp", "Pict", "Pike", "PIKT", "PILOT", "Pipelines", "Pizza", "PL-11", "PL/0", "PL/B", "PL/C", "PL/I", "PL/M", "PL/P", "PL/SQL", "PL360", "PLANC", "Plankalkül", "Planner", "PLEX", "PLEXIL", "Plus", "POP-11", "PostScript", "PortablE", "Powerhouse", "PowerBuilder", "PowerShell", "PPL", "Processing", "Processing.js", "Prograph", "PROIV", "Prolog", "PROMAL", "Promela", "PROSE modeling language", "PROTEL", "ProvideX", "Pro*C", "Pure", "Python", "Q (equational programming language)", "Q (programming language from Kx Systems)", "Qalb", "QtScript", "QuakeC", "QPL", "R", "R++", "Racket", "RAPID", "Rapira", "Ratfiv", "Ratfor", "rc", "REBOL", "Red", "Redcode", "REFAL", "Reia", "Revolution", "rex", "REXX", "Rlab", "RobotC", "ROOP", "RPG", "RPL", "RSL", "RTL/2", "Ruby", "RuneScript", "Rust", "S", "S2", "S3", "S-Lang", "S-PLUS", "SA-C", "SabreTalk", "SAIL", "SALSA", "SAM76", "SAS", "SASL", "Sather", "Sawzall", "SBL", "Scala", "Scheme", "Scilab", "Scratch", "Script.NET", "Sed", "Seed7", "Self", "SenseTalk", "SequenceL", "SETL", "Shift Script", "SIMPOL", "SIGNAL", "SiMPLE", "SIMSCRIPT", "Simula", "Simulink", "SISAL", "SLIP", "SMALL", "Smalltalk", "Small Basic", "SML", "Snap!", "SNOBOL", "SPITBOL", "Snowball", "SOL", "Span", "SPARK", "Speedcode", "SPIN", "SP/k", "SPS", "Squeak", "Squirrel", "SR", "S/SL", "Stackless Python", "Starlogo", "Strand", "Stata", "Stateflow", "Subtext", "SuperCollider", "SuperTalk", "Swift (Apple programming language)", "Swift (parallel scripting language)", "SYMPL", "SyncCharts", "SystemVerilog", "T", "TACL", "TACPOL", "TADS", "TAL", "Tcl", "Tea", "TECO", "TELCOMP", "TeX", "TEX", "TIE", "Timber", "TMG", "Tom", "TOM", "Topspeed", "TPU", "Trac", "TTM", "T-SQL", "TTCN", "Turing", "TUTOR", "TXL", "TypeScript", "Turbo C++", "Ubercode", "UCSD Pascal", "Umple", "Unicon", "Uniface", "UNITY", "Unix shell", "UnrealScript", "Vala", "VBA", "VBScript", "Verilog", "VHDL", "Visual Basic", "Visual Basic .NET", "Visual DataFlex", "Visual DialogScript", "Visual Fortran", "Visual FoxPro", "Visual J++", "Visual J#", "Visual Objects", "Visual Prolog", "VSXu", "Vvvv", "WATFIV, WATFOR", "WebDNA", "WebQL", "Windows PowerShell", "Winbatch", "Wolfram", "Wyvern", "X++", "X#", "X10", "XBL", "XC", "XMOS architecture", "xHarbour", "XL", "Xojo", "XOTcl", "XPL", "XPL0", "XQuery", "XSB", "XSLT", "XPath", "Xtend", "Yorick", "YQL", "Z notation", "Zeno", "ZOPL", "ZPL"];

$(function () {
    var sortByStarsContainer = $('#sortByStars');
    var dataDiv = $('#data');
    var itemsDiv = $('#items');
    var languageInput = $('#language');
    var minStarsInput = $('#stars');
    var maximumRepoCountToFetchInput = $('#maximumRepoCountToFetch');
    var totalResultsDiv = $('#totalResults');
    var repoCountSpan = $('#repoCount');
    var starCountSpan = $('#starCount');
    var languageNameSpan = $('#languageName');
    var lastAPICallDurationSpan = $('span#lastAPICallDuration');
    var lastAPICallAtSpan = $('span#lastAPICallAt');
    var apiCallsThisMinuteSpan = $('#APICallsThisMinute');
    var maxRepoReturnedByGitHubPerPage = 100;
    var sortByStarsValue;

    (function () {
        $('#language').autocomplete({
            source: languages
        });
    })();

    (function sortByStarsFunction() {
        var descClass = 'glyphicon-sort-by-order-alt';
        var ascClass = 'glyphicon-sort-by-order';
        var enabledClass = descClass;
        var disabledClass = ascClass;
        sortByStarsValue = 'desc';
        sortByStarsContainer.children().filter('.order').addClass(enabledClass);
        sortByStarsContainer.children().filter('.order').on('click', function () {
            sortByStarsValue = sortByStarsValue === 'desc' ? 'asc' : 'desc';
            $(this).toggleClass(enabledClass).toggleClass(disabledClass);
            var tmp = disabledClass;
            disabledClass = enabledClass;
            enabledClass = tmp;
        });

    })();

    function sessionSaveName(name) {
        var savedNames = sessionStorage.getItem('saved-names') || '';
        var namesArray = savedNames.split('_');
        namesArray.push(name);
        sessionStorage.setItem('saved-names', namesArray.join('_'));
    }
    function sessionSave(name, value) {
        sessionStorage.setItem(name, value);
        sessionSaveName(name);
    }
    function sessionRetrieve(name, value) {
        sessionStorage.getItem(name);
    }
    function createItems(allItems) {
        itemsDiv.html('');
        function createItem(item) {
            function createAnchor(href, name) {
                return $('<a href="' + href + '" target="_blank">' + name + '</a>');
            }
            function createHeader(item) {
                var headerContainer = $('<h4></h4>');
                headerContainer.append(createAnchor(item.html_url, item.full_name));
                return headerContainer;
            }
            function createDescription(desc) {
                var descriptionContainer = $('<div class="detail description"></div>');
                descriptionContainer.html(desc);
                return descriptionContainer
            }
            function createCreatedXDaysAgo(date) {
                var then = moment(date);
                var days = moment().diff(then, 'days');
                var container = $('<span class="detail stat created" title="started ' + days + ' days ago" data-toggle="tooltip" data-placement="top"></span>');
                var image = $('<span class="glyphicon glyphicon-triangle-right"></span>');
                container.append(image);
                container.append(days);
                return container;
            }
            function crateStars(starCount) {
                var container = $('<span class="detail stat starCount" title="Number of stars" data-toggle="tooltip" data-placement="top"></span>');
                var image = $('<span class="glyphicon glyphicon-star"></span>');
                container.append(image);
                container.append('<span>' + starCount + '</span>');
                return container;
            }
            function crateWatchers(watchersCount) {
                var container = $('<span class="detail stat watchersCount" title="Number of watchers" data-toggle="tooltip" data-placement="top"></span>');
                var image = $('<span class="glyphicon glyphicon-eye-open"></span>');
                container.append(image);
                container.append('<span>' + watchersCount + '</span>');
                return container;
            }
            function createDownloadSize(size) {
                var container = $('<span class="detail stat downloadSize" title="Size of repo in KiB" data-toggle="tooltip" data-placement="top"></span>');
                var image = $('<span class="glyphicon glyphicon-floppy-save"></span>');
                container.append(image);
                container.append('<span>' + size + '</span>');
                return container;
            }
            function createUpdatedXDaysAgo(date) {
                var then = moment(date);
                var title = 'days';
                var time = moment().diff(then, title);
                if (time < 1) {
                    title = 'hours';
                    time = moment().diff(then, title);
                    if (time < 1) {
                        title = 'minutes';
                        time = moment().diff(then, title);
                        if (time < 1) {
                            title = 'seconds';
                            time = moment().diff(then, title);
                        }
                    }
                }
                title = time === 1 ? title.substr(0, title.length - 1) : title;
                var container = $('<span class="detail stat created" title="updated ' + time + ' ' + title + ' ago" data-toggle="tooltip" data-placement="top"></span>');
                var image = $('<span class="glyphicon glyphicon-edit"></span>');
                container.append(image);
                container.append(time);
                return container;
            }
            function createOpenIssues(count) {
                var container = $('<span class="detail stat openIssues" title="Open issues" data-toggle="tooltip" data-placement="top"></span>');
                var image = $('<span class="glyphicon glyphicon-fire"></span>');
                container.append(image);
                container.append('<span>' + count + '</span>');
                return container;
            }
            function createHomepage(homepageURL) {
                var container = $('<span class="detail stat homepage" title="Homepage" data-toggle="tooltip" data-placement="top"></span>');
                container.append('<span><a href="' + homepageURL + '" target="_blank"><span class="glyphicon glyphicon-home"></span></a></span>');
                return container;
            }
            function createLanguage(lang) {
                var container = $('<span class="detail stat language" title="Language of the project" data-toggle="tooltip" data-placement="top"></span>');
                container.append('<span>' + lang + '</span>');
                return container;
            }

            console.log('createItem', item);
            var itemContainer = $('<div class="col-md-4 repo"></div>');
            var header = createHeader(item);
            itemContainer.append(header);
            itemContainer.append(createDescription(item.description));
            itemContainer.append(createLanguage(item.language));
            itemContainer.append(createCreatedXDaysAgo(item.created_at));
            itemContainer.append(crateStars(item.stargazers_count));
            itemContainer.append(crateWatchers(item.watchers_count));
            itemContainer.append(createDownloadSize(item.size));
            itemContainer.append(createUpdatedXDaysAgo(item.updated_at));
            itemContainer.append(createHomepage(item.homepage));

            return itemContainer;
        }
        function creatItemsForPage(items) {
            console.log('creatItemsForPage', items);
            var pageContainer = $('<div></div>');
            items.forEach(function (item) {
                createItem(item).appendTo(pageContainer);
            });
            return pageContainer;
        }
        dataDiv.pagination({
            dataSource: allItems,
            pageSize: maxRepoReturnedByGitHubPerPage,
            callback: function (data, pagination) {
                var page = creatItemsForPage(data);
                console.log('page', page);
                itemsDiv.html(page);
            }
        });
        $('[data-toggle="tooltip"]').tooltip();
    };
    function postSuccess_stats(totalCount, minStars, languageName, remaining, total) {
        totalResultsDiv.addClass('displayB');
        dataDiv.addClass('displayB');
        repoCountSpan.html(totalCount);
        starCountSpan.html(minStars);
        languageNameSpan.html(languageName);
        apiCallsThisMinuteSpan.html(remaining + '/' + total);
    }
    $('#search').on('click', function () {
        totalResultsDiv.removeClass('displayB');
        dataDiv.removeClass('displayB');
        var language = languageInput.val();
        var minStars = minStarsInput.val();
        var maximumRepoCountToFetch = maximumRepoCountToFetchInput.val();
        var numberOfPages = Math.floor(maximumRepoCountToFetch / maxRepoReturnedByGitHubPerPage);
        var URI = 'https://api.github.com/search/repositories?q=stars:>='
            + minStars
            + '+language:'
            + encodeURIComponent(language)
            + '&sort=stars&order='
            + sortByStarsValue
            + '&page='
            + numberOfPages
            + '&per_page='
            + maxRepoReturnedByGitHubPerPage;

        $('html, body, #search').css('cursor', 'wait');
        var lastAPICallTime = moment();
        lastAPICallAtSpan.html(lastAPICallTime.format('hh:mm:ss'));
        sessionSave('lastAPICallTime', lastAPICallTime);
        $.getJSON(URI)
            .done(function (json, success, moreActions) {
                var remaining = moreActions.getResponseHeader('X-RateLimit-Remaining');
                var total = moreActions.getResponseHeader('X-RateLimit-Limit');
                postSuccess_stats(json.total_count, minStars, language, remaining, total);
                createItems(json.items);
                console.log(json);
            })
            .fail(function (jqxhr, textStatus, error) {
                $('#data').html();
                console.error("ERROR: " + textStatus + ", " + error);
                console.error("ERROR: " + URI);
            })
            .always(function () {
                console.log(URI + " loading finished.");
                $('html, body, #search').css('cursor', 'auto');
                var now = moment();
                lastAPICallDurationSpan.html(now.diff(lastAPICallTime, 'seconds'));
            });

    });

});